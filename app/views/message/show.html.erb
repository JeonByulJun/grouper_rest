<body style="position: absolute;">
<!-- Chat Sidetab -->
<div class="sidetab">
  <div id="chat-icon-box" class="tabbable tabs-left">
    <center><span id="chat-icon-member" href="#tab1" data-toggle="tab" role="button" class="glyphicon glyphicon-user" aria-hidden="true" style="color: white;"></span></center>
    <br>
    <center><span id="chat-icon-chatlist" href="#tab2" data-toggle="tab" role="button" class="glyphicon glyphicon-comment" aria-hidden="true" style="color: white;"></span></center>
    <br>
    <center><span id="chat-icon-chatlist" href="#tab3" data-toggle="tab" role="button" class="glyphicon glyphicon-hand-right" aria-hidden="true" style="color: white;"></span></center>
  </div>
</div>

<!-- Memberlist & Chatlist Sidebar -->
<div class="home sidebar" id="sidebar">
  <div class="tab-content">
    <div class="tab-pane" id="tab1">
      <% temp = [] %>
      <% temp += @team.users.order(first_name: :asc) %>
      <div class="row" id="chat_top">
        <div class="col-sm-6"><h2 style="color: #372727;">팀 멤버</h2></div>
        <div class="col-sm-1"><h2><%=temp.count%></h2></div>
        <div class="col-sm-2"></div>
        <form action="/team/addmember" method="get">
          <input type="hidden" name="team" value="<%=@team.id%>"/>
          <div class="col-sm-2"><button type="submit" class="btn btn-new btn-circle btn-lg" data-toggle="tooltip" data-placement="bottom" title="팀원 추가" style="margin-top: 8px;"><i class="glyphicon glyphicon-plus"></i></button></div>
        </form>
        <div class="col-sm-1"></div>
      </div>
      <!-- My Profile -->
      <div class="row" id="chat_top">
        <div class="col-sm-12">
          <h5 style="color: #52D5CC">나</h3>
        </div>
      </div>
      <div class="row" id="chat_top">
        <div id="profile_me" class="col-sm-12">
          <aside style="padding-left: 12px;">
            <img id="img_setting" class="img-circle" alt="profile" src="<%=current_user.image%>">
          </aside>
          <h5 style="color: black; font-size: 18px; padding-top: 15px;"><%=current_user.first_name%></h5>
        </div>
      </div>
      
      <!-- Others Profile -->
      <div class="row" id="chat_top">
        <div class="col-sm-12">
          <h5 style="color: #52D5CC">팀원</h3>
        </div>
      </div>
      <% temp.each_with_index do |t,idx| %>
        <% if t.id != current_user.id %>
          <div class="row" id="chat_top">
            <div id="profile<%=idx%>" class="col-sm-12">
              <aside style="padding-left: 12px;">
                <img id="img_setting" class="img-circle" alt="profile" src="<%=t.image%>">
              </aside>
              <h5 style="color: black; font-size: 18px; padding-top: 15px;"><%=t.first_name%></h5>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
    
    <!-- Tab2: List of chat rooms -->
    <div class="tab-pane" id="tab2">
      <div class="row" id="chat_top">
        <div class="col-sm-6"><h2 style="color: #372727;">회의방</h2></div>
        <div class="col-sm-3"></div>
        
        <div class="col-sm-2"><button class="btn btn-new btn-circle btn-lg" type="button" data-toggle="collapse" data-placement="bottom" data-target="#addchatroom2" aria-expanded="false" aria-controls="addchatroom" style="margin-top: 8px;"><span class="glyphicon glyphicon-plus" data-toggle="tooltip" data-placement="bottom" title="회의방 추가"></span></button></div>
        <div class="col-sm-1"></div>

        
      </div>
      <div class="row collapse" id="addchatroom2">
        <form action="/chat/create" method="post">
          <div id="chat_top">
            회의방 이름 <input type="text" name="title" required>
            <input type="hidden" name="team" value=<%=@team.id%>>
          </div>
          <br />
          <% temp.each_with_index do |t,idx| %>
            <% if t.id != current_user.id %>
              <div class="row" id="chat_top">
                <div id="profile<%=idx%>" class="col-sm-12">
                  <aside style="padding-left: 12px;">
                    <img id="img_setting" class="img-circle" alt="profile" src="<%=t.image%>">
                  </aside>
                  <h5 style="color: black;"><%=t.first_name%></h5>
                  <%= check_box_tag('user_ids[]', t.id) %>
                </div>
              </div>
            <% end %>
          <% end %>
          <%= hidden_field_tag :authenticity_token, form_authenticity_token -%>
          <div class="col-sm-2"><button type="submit" vlaue="Send" class="btn btn-new btn-circle btn-lg"><i class="glyphicon glyphicon-plus"></i></button></div>
        </form>
      </div>
      <div class="row" id="chat_top">
        <div class="col-sm-12">
          <h5 style="color: #52D5CC">방 목록</h3>
        </div>
      </div>
      
      <% if @chat_side %>
        <% @chat_side.each do |chat| %>
          <div class="row" id="chat_top">
            <form action ="/message/show" method="get">
              <div id="profile_me" class="col-sm-12">
                    <input type="hidden" name="chat" value="<%=chat.id%>">
                    <input class="btn btn-default" type="submit" value="<%=chat.title%>">
              </div>
            </form>
          </div>
        <% end %>
      <% end %>
    </div>
    
    <!-- Tab3: Giving Tasks -->
    <div class="tab-pane" id="tab3">
      <div class="row" id="chat_top">
        <div class="col-sm-6"><h2 style="color: #372727;">Give Tasks</h2></div>
        <div class="col-sm-1"><h2> </h2></div>
        <div class="col-sm-3"></div>
      </div>
      
      <form action="/task/create" method="post">
        <div class="row" id="chat_top2">
          <div class="form-group">
            <div class="col-md-10">
              <label for="taskname_text"><span class="glyphicon glyphicon-briefcase" aria-hidden="true" style="padding-top: 2px; margin-right: 2px;"></span>Taskname</label>
              <input type="text" class="form-control" name="taskname" id="taskname_text" placeholder="Give Your Task">
            </div>
          </div>
        </div>
        
        <div class="row" id="chat_top">
          <div class='col-sm-10'>
            <label for="datetimepicker1"><span class="glyphicon glyphicon-calendar" aria-hidden="true" style="padding-top: 2px; margin-right: 2px;"></span>Duedate</label>
            <div class="form-group">
                <div class='input-group date' id='datetimepicker1'>
                  <input type='text' class="form-control" name="duedate"/>
                  <span class="input-group-addon">
                    <span class="glyphicon glyphicon-calendar"></span>
                  </span>
                </div>
            </div>
          </div>
          <div class='col-sm-2'>
            <button type="submit" value="send" class="btn btn-info btn-sm" aria-haspopup="true" aria-expanded="false" style="font-size: 13px; margin-top: 27px;">
              Enroll
            </button>
          </div>
          <script type="text/javascript">
            $(function () {
              $('#datetimepicker1').datetimepicker({
                format : 'YYYY-MM-DD'
              });
            });
          </script>
        </div>
        
        <!-- My Profile -->
        <div class="row" id="chat_top">
          <div class="col-sm-12">
            <h5 style="color: #52D5CC">나</h3>
          </div>
        </div>
        <div class="row" id="chat_top">
          <div id="profile_me" class="col-sm-11">
            <aside style="padding-left: 12px;">
              <img id="img_setting" class="img-circle" alt="profile" src="<%=current_user.image%>">
            </aside>
            <h5 style="color: black; font-size: 18px; padding-top: 15px;"><%=current_user.first_name%></h5>
          </div>
          <div id="profile_me" class="col-sm-1">
            <%= check_box_tag('user_ids[]', current_user.id) %><br />
          </div>
        </div>
        
        <!-- Others Profile -->
        <div class="row" id="chat_top">
          <div class="col-sm-12">
            <h5 style="color: #52D5CC">팀원</h3>
          </div>
        </div>
        <% temp.each_with_index do |t,idx| %>
          <% if t.id != current_user.id %>
            <div class="row" id="chat_top">
              <div id="profile_me" class="col-sm-11">
                <aside style="padding-left: 12px;">
                  <img id="img_setting" class="img-circle" alt="profile" src="<%=t.image%>">
                </aside>
                <h5 style="color: black; font-size: 18px; padding-top: 15px;"><%=t.first_name%></h5>
              </div>
              <div id="profile_me" class="col-sm-1">
                <%= check_box_tag('user_ids[]', t.id) %><br />
              </div>
            </div>
          <% end %>
        <% end %>
        <%= hidden_field_tag :authenticity_token, form_authenticity_token -%>
        <input type="hidden" name="team" value=<%=@team.id%>>
      </form>
    </div>
    <!-- end of Tab3 -->
  </div>
</div>


  <br>
  <br>
  <br>
  <div style="text-align:center">
    <h3><%=@chat.title %></h3>
  </div>



  <div class="row">
    <div class="col-sm-6">
      <div style="text-align:center">채팅창</div>
      <div style="overflow:scroll; overflow-x:hidden; word-wrap:break-word; word-break:break-all; width:auto; height:400px;" id="chatbox">

        <% @chat.messages.each do |message| %>

          <div class="row messages">
            <div class="col-sm-1">
              <img src="<%= User.find(message.sender_id).image.url %>" alt="User.find(message.sender_id).first_name" class="img-circle" onmouseover="bigImg(this)" onmouseout="normalImg(this)" style="padding-top:2px; padding-left:2px" width="36px" height="36px">
            </div>
            <div class="col-sm-11">
              <div id="message<%=message.id%>">
                <strong><%=User.find(message.sender_id).first_name%></strong><br>
                <% if message.messagetype == 0 %>
                  <%=message.content%><br>
                <% end %>
                <% if message.messagetype == 1 %>
                  <a href="<%=message.imagemessage.imagemessageupload.url%>"><img class="imagemessageload" src="<%=message.imagemessage.imagemessageupload.url%>" style="padding: 10px; max-width: 70%; height: auto;"></a><br>
                <% end %>
                <% if message.messagetype == 2 %>
                  THIS CONTENT IS FILE!<br>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <%= sync_new partial: 'newmessages', resource: Message.new, scope: @chat%>
      </div>


        <%= form_for(:message, :url => {:controller => 'message', :action => 'create'}, :remote => true, :html => {:id => "messageform"}) do |f| %>
          <%= f.hidden_field :chat_id, :value => @chat.id %>
          <div class="form-group has-success has-feedback">
            <div class="dropup">
              <div class="input-group">
                <span class="input-group-addon" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  +
                </span>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenu2">
                  <li><a><label for="fileupload" style="cursor: pointer;"><span class="glyphicon glyphicon-file"></span> 파일업로드</label></a></li>
                  <li><a><label for="imageupload" style="cursor: pointer;"><span class="glyphicon glyphicon-picture"></span> 사진업로드</label></a></li>
                </ul>
                <input type="text" name="message[content]" class="form-control" id="inputGroupSuccess1" aria-describedby="inputGroupSuccess1Status" autofocus required autocomplete="off">
              </div>
            </div>
          </div>

        <%end%>




      <form id="imagefileupload" class="form-inline" action="/imageup" method="post" enctype="multipart/form-data" data-remote="true">
        <input type="hidden" name="chat_id" value=<%= @chat.id %>>
        <%= hidden_field_tag :authenticity_token, form_authenticity_token -%>

        <input id="imageupload" type="file" name="image_file" style="visibility:hidden;position:absolute;top:0;left:0;">
      </form>

      <form id="filefileupload" class="form-inline" action="/fileup" method="post" enctype="multipart/form-data" data-remote="true">
        <input type="hidden" name="chat_id" value=<%= @chat.id %>>
        <%= hidden_field_tag :authenticity_token, form_authenticity_token -%>

        <input id="fileupload" type="file" name="file_file" style="visibility:hidden;position:absolute;top:0;left:0;">
      </form>

      <button type="hidden" style="visibility:hidden;position:absolute;top:0;left:0;" class="btn btn-primary btn-lg" id="imshow" data-toggle="modal" data-target="#myModal"></button>

      <!-- Modal -->
      <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-body">
              <img id="blah" src="#" alt="your image" style="padding: 10px; max-width: 100%; height: auto;"/>
            </div>
            <div class="modal-footer">

              <button id="closemodal" type="button" class="btn btn-default" data-dismiss="modal">취소</button>
              <button id="imagesubmit" type="button" onclick="$('#imagefileupload').submit();$('#closemodal').click(); this.disabled=true;" class="btn btn-primary">이미지 올리기</button>
            </div>
          </div>
        </div>
      </div>


      <script type="text/javascript">

        $(document).ready(function(){
          $("#fileupload").on('click',function(){
            this.value=null;
          });
        })
        $(function(){
          $("#fileupload").on('change',function(){
            $("#filefileupload").submit();
          });
        });


        $(document).ready(function(){
          $("#imageupload").on('click',function(){
            this.value=null;
          });
        })


        $(function(){
          $("#imageupload").on('change',function(){
            $("#imagesubmit").prop('disabled', false);
            document.getElementById('imshow').click();
            readURL(this);
          });
        });

        function readURL(input){
          if(input.files && input.files[0]){
            var reader = new FileReader();

            reader.onload = function(e){
              $('#blah').attr('src',e.target.result);
            }

            reader.readAsDataURL(input.files[0]);
          }
        }
      </script>




      <script>
        $(document).ready(function(){
          $("#inputGroupSuccess1").keydown(function(event){
              if(event.keyCode == 13){
                $("#messageform").submit();

                $('#inputGroupSuccess1').val('');
                return false;
              }

          });
        });
      </script>
    </div>
    <div class="col-sm-6">
      <div style="text-align:center">
        화이트 보드
        <%= sync partial: "whiteboardedit", resource: @whiteboard, scope: @chat, refetch: true %>

        <nav>
          <ul class="pagination pagination-sm">
            <li><%=sync partial: 'whiteboardcondition', resource: @whiteboard, scope: @chat, refetch: true%></li>
            <form action="/whiteboard/update2" method="post" id="whiteboardchangeform" data-remote=true>
              <input type="hidden" name="whiteboardid" value=<%=@whiteboard.id%>>
              <%= hidden_field_tag :authenticity_token, form_authenticity_token -%>
            </form>

          </ul>
        </nav>
      </div>
    </div>
  </div>
  <div id="messagelook"></div>
  <% if @chat.messages.count != 0 %>
    <form action="/message/update" method="put" data-remote=true id="messagelookall">
      <input type="hidden" name="messageid" value=<%=@chat.messages.last.id%>>
    </form>
  <% end %>

  <script>
    $(document).ready(function(){
      <%if @message %>
          $('#chatbox').animate({ scrollTop: $('#message<%=@message.id%>').offset().top -200});
          $("#message<%=@message.id%>").append("-----------여기까지 읽었습니다-----------");

      <% end %>
      <% if current_user == @whiteboard.user && @whiteboard.edit == true %>
        $("#whiteboardblock").removeAttr('disabled');
        $("#whiteboardblock span").text("완료");
        $("#whiteboardblock").attr('id', 'whiteboardsend');
        $("#whiteboardarea").removeAttr('readonly');
      <% end %>

      $("#whiteboardsend").click(function(){
        $("#whiteboardform").submit();
      });

      $("#whiteboardchange").click(function(){
        $("#whiteboardchangeform").submit();
      });
    });

    $(document).ready(function(){
      $('#messagelookall').submit();
    });
  </script>
  <script>
  function bigImg(x) {
      x.style.height = "56px";
      x.style.width = "56px";
  }

  function normalImg(x) {
      x.style.height = "36px";
      x.style.width = "36px";
  }

  function search(x) {
      $('#chatbox').animate({ scrollTop: $("#message"+x).offset().top-200 });
  }
  </script>

  <script>
  $(document).ready(function(){
      $(".messages").hover(function(){
          $(this).css("background-color", "#F2F2F2");
          }, function(){
          $(this).css("background-color", "white");
      });
  });
  </script>
</body>